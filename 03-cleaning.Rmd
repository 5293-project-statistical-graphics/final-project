# Data transformation

The raw data comes in json format. We simply extracted desired properties from each entries and put them in a tibble.
```{r}
library(tidyverse)
library(jsonlite)
```


```{r}
commit.ggplot.raw <- read_json(path = "resources/rawdata/ggplot2_commits.json")
commit.ggplot <- tibble(commit_info = commit.ggplot.raw) %>%
  mutate(
    author = sapply(commit_info, function(x){x$author$login}),
    date = sapply(commit_info, function(x){x$commit$author$date}),
    message = sapply(commit_info, function(x){x$commit$message}),
    url = sapply(commit_info, function(x){x$html_url}),
    repo = "ggplot2"
    ) %>% 
  select(-commit_info) %>% unnest(author)

commit.plotly.raw <- read_json(path = "resources/rawdata/plotly.R_commits.json")
commit.plotly <- tibble(commit_info = commit.plotly.raw) %>%
  mutate(
    author = sapply(commit_info, function(x){x$author$login}),
    date = sapply(commit_info, function(x){x$commit$author$date}),
    message = sapply(commit_info, function(x){x$commit$message}),
    url = sapply(commit_info, function(x){x$html_url}),
    repo = "plotly.R"
    ) %>% 
  select(-commit_info) %>% unnest(author)
### not run
#bind_rows(commit.ggplot, commit.plotly) %>% write_csv("resources/data/commits.csv")
### END not run
```
In previous chapter, we mentioned that the issue API will return both issues and pull requests. Therefore, we will need to differentiate them between each other and store them in separate tibble. And the main difference between issues and pull requests is that pull request entries have a "pull request" property.
```{r}
issues.ggplot.raw <- read_json(path = "resources/rawdata/ggplot2_issues.json")
issues.ggplot <- tibble(issue_info = issues.ggplot.raw) %>%
  mutate(
    author = sapply(issue_info, function(x){x$user$login}),
    author_association = sapply(issue_info, function(x){x$author_association}),
    state = sapply(issue_info, function(x){x$state}),
    comments = sapply(issue_info, function(x){x$comments}),
    pull_request = sapply(issue_info, function(x){x$pull_request$html_url}),
    created_at = sapply(issue_info, function(x){x$created_at}),
    updated_at = sapply(issue_info, function(x){x$updated_at}),
    closed_at = sapply(issue_info, function(x){x$closed_at}) %>% as.character(),
    title = sapply(issue_info, function(x){x$title}),
    body = sapply(issue_info, function(x){x$body}) %>% as.character(),
    url = sapply(issue_info, function(x){x$html_url}),
    repo = "ggplot2"
    ) %>%
  select(-issue_info)
pull_request.ggplot <- issues.ggplot %>% 
  filter(sapply(pull_request, length) != 0) %>% 
  unnest(c(pull_request, closed_at, body)) %>%
  mutate(closed_at = ifelse(closed_at == "list()", NA, closed_at))
issues.ggplot <- issues.ggplot %>%
  filter(sapply(pull_request, length) == 0) %>% 
  select(-pull_request) %>%
  unnest(c(closed_at, body)) %>%
  mutate(closed_at = ifelse(closed_at == "list()", NA, closed_at))

issues.plotly.raw <- read_json(path = "resources/rawdata/plotly.R_issues.json")
issues.plotly <- tibble(issue_info = issues.plotly.raw) %>%
  mutate(
    author = sapply(issue_info, function(x){x$user$login}),
    author_association = sapply(issue_info, function(x){x$author_association}),
    state = sapply(issue_info, function(x){x$state}),
    comments = sapply(issue_info, function(x){x$comments}),
    pull_request = sapply(issue_info, function(x){x$pull_request$html_url}),
    created_at = sapply(issue_info, function(x){x$created_at}),
    updated_at = sapply(issue_info, function(x){x$updated_at}),
    closed_at = sapply(issue_info, function(x){x$closed_at}) %>% as.character(),
    body = sapply(issue_info, function(x){x$body}) %>% as.character(),
    url = sapply(issue_info, function(x){x$html_url}),
    repo = "plotly"
  ) %>%
  select(-issue_info)
pull_request.plotly <- issues.plotly %>% 
  filter(sapply(pull_request, length) != 0) %>% 
  unnest(c(pull_request, closed_at, body)) %>%
  mutate(closed_at = ifelse(closed_at == "list()", NA, closed_at))
issues.plotly <- issues.plotly %>%
  filter(sapply(pull_request, length) == 0) %>% 
  select(-pull_request) %>%
  unnest(c(closed_at, body)) %>%
  mutate(closed_at = ifelse(closed_at == "list()", NA, closed_at))

# not run
# bind_rows(issues.ggplot, issues.plotly) %>% write_csv("resources/data/issues.csv")
# bind_rows(pull_request.ggplot, pull_request.plotly) %>% write_csv("resources/data/pull_requests.csv")
### END not run
```
All the transformed data are stored under [resources/data](https://github.com/5293-project-statistical-graphics/final-project/tree/main/resources/data){target="_blank} folder.
