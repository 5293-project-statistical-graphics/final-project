# Results

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
``` 

```{r}
library(ggridges)
library(lubridate)
library(tidyverse)
library(gridExtra)
```

## Users prefer weekdays or weekends?
```{r}
commit <- read_csv("resources/data/commits.csv") %>% filter(year(date) >= 2014)
issue <- read_csv("resources/data/issues.csv")  %>% filter(year(created_at) >= 2014)
pull <- read_csv("resources/data/pull_requests.csv")  %>% filter(year(created_at) >= 2014)
issue_and_pull_request <- bind_rows(issue %>% mutate(category = "issue"), pull %>% mutate(category = "pull request"))
```

Users of Github prefer to create pull requests, issues and commits during weekdays rather than weekends. The number of all pull requests, issues and commits for plotly are smaller than ggplot2. ggplot2 is more popular than plotly on Github.
```{r, fig.height=10}
# function to make bar plot, number versus wday
bar_plot <- function(tibble){
  tibble %>%
    select(repo, date) %>%
    mutate(created_wday = wday(date,label=T)) %>%
    count(repo, created_wday, name = "count") %>%
    ggplot(aes(x = created_wday, y = count))+
    geom_col()+
    facet_wrap(~repo)
}
# commit per weekday
g1 <- bar_plot(commit) + 
  labs(x = "created at (weekday)", title = "Number of commits created per weekday")
# issue per weekday
g2 <- bar_plot(issue %>% rename(date = created_at)) + 
  labs(x = "created at (weekday)", title = "Number of issues created per weekday")
# pull per weekday
g3 <- bar_plot(pull %>% rename(date = created_at)) +
  labs(x = "created at (weekday)", title = "Number of pull request created per weekday")
grid.arrange(g2, g3, g1, ncol=1)
```

## Are users more attached during years?

For plotly, the number of issues and commits first increases and then has a decreasing trend after 2016. And for number of pull request of plotly, it has a decreasing trend.   
Users are more interested in the package when it newly came out. After pandemic, less focus is put on these two packages.  
```{r, fig.height=8}
# function to make line chart, number versus year
line_plot <- function(tibble){
  tibble %>%
    select(repo, date) %>%
    mutate(year = year(date)-2000) %>%
    count(repo, year, name = "count") %>%
    ggplot(aes(x = year, y = count)) + 
    geom_line() + geom_point() +
    facet_wrap(~repo) +
    scale_x_continuous(breaks=14:21)
}
# commits per year
g4<- line_plot(commit) +
  labs(x = "created at (year)", title = "Number of commits")
# issue per year
g5 <- line_plot(issue %>% rename(date = created_at)) +
  labs(x = "created at (year)", title = "Number of issues")
# pull per year
g6 <- line_plot(pull %>% rename(date = created_at)) +
  labs(x = "created at (year)", title = "Number of pull requests")

grid.arrange(g5, g6, g4, ncol = 1)
```

## Which roles attached most during years?

We can look into details of users roles to explore. Due to the same meaning in the definition of "COLLABORATOR" and "MEMBER" in these two packages, we combine these two classes into "MEMBER". Issues are mainly created by common users of these packages. Pull requests are mostly created by members of these packages. Due to pandemic, these packages are not as popular as before.
```{r}
# function to make multi-line plot, number for different author_association versus year
multi.line_plot <- function(tibble){
  tibble %>%
    select(repo, author_association, created_at, category) %>%
    mutate(created_year = year(created_at) - 2000) %>%
    mutate(author_association = 
             ifelse(author_association %in% c("MEMBER", "COLLABORATOR"), 
                    "COLLABORATOR / MEMBER", author_association)) %>%
    count(repo, category, author_association, created_year, name = "number") %>%
    ggplot(aes(x = created_year, y = number, color = author_association)) +
    geom_line() + geom_point() +
    facet_grid(category~repo, scale = "free_y") + 
    scale_x_continuous(breaks = 14:21)
}
# issue of different author association per year
multi.line_plot(issue_and_pull_request) +
  labs(x = "created at (year)", y = "number", color = "author association",
       title = "Breakdown of numbers of issues/pull requests over author association")

```

## Do distributions of different roles vary?

The distribution of different roles may have an influence on the previous question. Therefore, we need to focus on the distributions of different roles. Both packages have similar distribution shape for all author associations and they all have long right tail. And there is a small peak for comments equal to 10 for plotly. Comparing two packages, ggplot2 is more likely to have a heavy tail.

```{r}
g9<-issue %>% 
  select(repo, comments, author_association) %>%
  mutate(author_association=case_when(author_association=="COLLABORATOR"~"MEMBER",
                                      author_association=="CONTRIBUTOR"~"CONTRIBUTOR",
                                      author_association=="MEMBER"~"MEMBER",
                                      author_association=="NONE"~"NONE"))%>%
  filter(comments < 15) %>%
  ggplot(aes(x = comments, y = repo, fill = stat(quantile))) +
  stat_density_ridges(quantile_lines = FALSE, calc_ecdf = TRUE, bandwidth = 1,
                      geom = "density_ridges_gradient") +
  facet_wrap(~author_association) +
  scale_fill_brewer(name = "quantile", labels = c("1st", "2nd", "3rd", "4th")) + 
  labs(title="Distribution of issue")+
  theme_ridges()

g10<-pull %>% 
  select(repo, comments, author_association) %>%
  mutate(author_association=case_when(author_association=="COLLABORATOR"~"MEMBER",
                                      author_association=="CONTRIBUTOR"~"CONTRIBUTOR",
                                      author_association=="MEMBER"~"MEMBER",
                                      author_association=="NONE"~"NONE"))%>%
  filter(comments < 15) %>%
  ggplot(aes(x = comments, y = repo, fill = stat(quantile))) +
  stat_density_ridges(quantile_lines = FALSE, calc_ecdf = TRUE, bandwidth = 1,
                      geom = "density_ridges_gradient") +
  facet_wrap(~author_association) +
  scale_fill_brewer(name = "quantile", labels = c("1st", "2nd", "3rd", "4th")) + 
  labs(title="Distribution of pull requests")+
  theme_ridges()
grid.arrange(g9,g10,ncol=1)
```

## Are most of issues and pull requests still unsolved?

Issue and pull request can have two status, open and closed, which indicates if the issue has been solved or if the pull request has been accepted/rejected. We can see that both packages have very few open pull requests but plotly has far more open issues than ggplot both in relative and absolute scale.
```{r}
issue_and_pull_request %>% 
  count(repo, category, state, name = "count") %>% 
  ggplot(aes(x = state, y = count, fill = repo, label = count)) + 
  geom_col(position = "dodge") + 
  geom_text(position = position_dodge(width = 1), vjust = -0.5) +
  facet_wrap(~category) +
  labs(title = "Plotly has more issues that are still open",
       subtitle = "ggplot2 v.s. plotly, number of open/close issues and pull requests.")
```

# Are open cases amounts increasing?

Let's first dive into the open issues. We can see that the percentage of "open" issues (issues whose status are still open) increases for plotly, especially for the past three years. Although we would expect some increases since earlier created issues are given more time to solve, yet plotly's increases is substantial (from 30%+ in 2019 to 50%+ in 2020 and to 70%+ in 2021). When compared to ggplot, plotly's percentage of both issues and pull requests are much higher even though plotly has fewer issue and pull requests than ggplot in absolute terms.
```{r}
issue_and_pull_request %>%
  select(created_at, closed_at, repo, author_association, state, repo, category) %>%
  mutate(created.year = (format(created_at, "%y")) %>% as.factor) %>%
  count(repo, category, created.year, state, name = "count") %>%
  group_by(repo, category, created.year) %>% 
  mutate(perc = count / sum(count)) %>%
  filter(state == "open") %>%
  ggplot(aes(x = created.year, y = perc, fill = repo)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~category) +
  labs(x = "created at (year)", y = "percentage" ,
       title = "% of issues whose status are still open increases over the past few year for Plotly",
       subtitle = "ggplot2 v.s. plotly, % of issues and pull requests created each year whose status are still open over 2014-2021",
       caption = "Note: percentage is calculated over total issues/pull requests created within each year")
```

## How long does it take to solve issues and pull requests?

Next, let's move our attention to closed issues and pull requests. We calculate issues and pull requests' solved time (which is defined as close time - create time) and divided the time into periods of 30 days (or 1 month). And we can see most of issues/pull requests were closed within one month but plotly seems to have larger percentage of issues that were open for more than one year.
```{r, fig.width=8}
time.period <- c(0, seq(30, 360, 30), 2000)
time.labels <- c(sapply(1:12, function(x){paste("<", x, " month", sep="")}), ">1 year")

issue_and_pull_request_perc <- issue_and_pull_request %>%
  select(created_at, closed_at, repo, author_association, state, repo, category) %>%
  mutate(created.year = (format(created_at, "%y")) %>% as.factor,
         solve.time = interval(created_at, closed_at) / days(1),
         solve.period = cut(solve.time, breaks=time.period, labels=time.labels)) 

issue_and_pull_request_perc %>%
  count(category, repo, solve.period, name = "count") %>%
  group_by(category, repo) %>% 
  mutate(perc = count / sum(count)) %>%
  filter(! is.na(solve.period)) %>%
  ggplot(aes(x = solve.period, y = perc, fill = repo)) +
  geom_col(position="dodge") +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~category, ncol = 1) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  labs(x = "time period", y ="percentage", 
       title = "Most of issues/pull requests were closed within one month.",
       subtitle = "% of issues/pull requests whose solved time falls into each periods of 1 month",
       caption = "Note: percentage is calculated over both open and closed issues/pull requests")

```

## Do different years have different solving pattern?

Breaking down the percentage over 2014-2021, we can see that both packages seems to having a trend of taking longer to "close" their issues. But the pattern is very different for pull requests, the percentage of pull requests closes within one month increases for the past several years. The contrast is most spark for plotly in 2021, only about 25 percent of issues are closed within two months, but over 80% of pull requests are closed within one month.
```{r, fig.height=8}
issue_and_pull_request_perc %>%
  count(category, repo, created.year, solve.period, name = "count") %>%
  group_by(category, repo, created.year) %>% 
  mutate(perc = count / sum(count)) %>%
  filter(! is.na(solve.period)) %>%
  ggplot(aes(x = created.year, y = solve.period, fill = perc)) +
  geom_tile() +
  scale_fill_gradient(low="white", high="blue") +
  facet_grid(category~repo) + 
  labs(x = "created at (year)", y = "time period", fill = "percentage", 
       title = "A detailed breakdown of percentages over 2014-2021.",
       caption = "Note: percentage is calculated over both open and closed issues/pull requests within each year")
```

